#!/usr/bin/env python3

# This Python file uses the following encoding: utf-8

import sys
# TODO: Remove unnecessary imports
from PySide2.QtCore import qDebug, Qt, QObject, Signal, Slot, QFile, QAbstractTableModel, QPoint, QRectF, QSizeF, QSize
from PySide2.QtWidgets import QApplication, QAction, QTableWidgetItem, QMenu
from PySide2.QtUiTools import QUiLoader
from PySide2.QtGui import QIcon, QKeySequence, QCursor, QTextDocument, QTextCursor, QPainter, QPageSize, QTextTableFormat, QTextImageFormat, QTextBlockFormat, QTextCharFormat, QFont, QBrush, QTextLength, QImage
from PySide2.QtPrintSupport import QPrinter
from PySide2.QtPrintSupport import QPrintPreviewWidget, QPrintPreviewDialog
import PySide2
TESTICON="option.svg"
TESTICONLINKED="linked.svg"

class Helper():
    def __init__(self):
        pass

    def genAction(self, name=None, fn=None, data=None, icon=None, shortcut=None, tip=None, parent=None):
        if name and fn:
            if icon:
                if isinstance(icon,str):
                    icon = QIcon(icon)
                elif isinstance(icon,QIcon):
                    pass
                else:
                    icon = None
            if icon:
                action = QAction(icon,name,parent)
            else:
                action = QAction(name,parent)
            
            if data != None:
                action.setData(data)

            if shortcut:
                if isinstance(shortcut,QKeySequence):
                    pass
                else:
                    try:
                        shortcut = QKeySequence(shortcut)
                    except:
                        shortcut = None
            if shortcut:
                action.setShortcuts(shortcut)
            
            if tip and isinstance(tip,str):
                action.setStatusTip(tip)

            action.triggered.connect(fn)

            return action
        return None

class tableHelper(QObject):
    def __init__(self, controller=None, table=None):
        QObject.__init__(self)
        if controller:
            self.controller = controller
        if table:
            self.setTableView(table)

    def setTableView(self, table):
        self.table = table
        self.model = table.model()
        self.table.setContextMenuPolicy(Qt.CustomContextMenu)
        self.table.customContextMenuRequested.connect(self.customMenu)
        self.table.cellClicked.connect(self.cellClicked)

    @Slot(int, int)
    def cellClicked(self, row, column):
        if column == 0:
            self.makeLinkedAction(row)

    @Slot(QPoint)
    def customMenu(self, position):
        qDebug("{}".format(position))
        item = self.table.itemAt(position)
        qDebug("item on x:{} y:{} with value {}".format(item.column(),item.row(),item.text()))
        qm = QMenu('titulo', self.table)
        if item.column()!=0:
            for seq in range(1,4):
                qm.addAction(Helper().genAction(name="ContextAction{}_{}".format(seq,item.text()),fn=self.printContextAction,data="ContextAction_{}_Data".format(seq,item.text()),icon=TESTICON,shortcut=None,tip="TipContextAction_{}".format(seq,item.text()),parent=qm))
            qm.addAction(Helper().genAction(name="Delete line '{}'".format(item.text()),fn=self.deleteContextAction,data=item.row(),icon=TESTICON,shortcut=None,tip="TipContextAction_Delete_{}".format(item.text()),parent=qm))
        else:
            self.makeLinkedAction(item.row())
        qm.exec_(QCursor.pos())
    
    @Slot()
    def printContextAction(self):
        data = self.sender().data()
        qDebug("senderData:{}".format(data))
        if self.controller:
            self.controller.window.statusbar.showMessage("Action from '{}' triggered".format(data),10*1000)

    @Slot()
    def deleteContextAction(self):
        data = self.sender().data()
        self.table.removeRow(data)
        if self.controller:
            self.controller.window.statusbar.showMessage("Deleted row {}".format(data),10*1000)

    def addItem(self, item):
        last_row = self.table.rowCount()
        self.table.insertRow(last_row)
        if not isinstance(item,list) and self.table.columnCount() >= 2:
            first_element = QTableWidgetItem(QIcon(),"")
            last_element = QTableWidgetItem("{}".format(item))
            itemlist = [first_element]
            for i in range(self.table.columnCount()-2):
                itemlist.append(QTableWidgetItem(""))
            itemlist.append(last_element)
        for i in range(len(itemlist)):
            self.table.setItem(last_row,i,itemlist[i])

    def makeLinkedAction(self, row):
        item = self.table.item(row,0)
        if item.icon():
            item.setIcon(QIcon())
        else:
            item.setIcon(QIcon(TESTICONLINKED))

class helperPDF():

    pageMargin = 10
    header_table_cols = 3
    header_table_rows = 2
    printer = None
    resolution = None
    document = None
    constPaperScreen = None
    cursor = None
    widget = None
    styles = None


    def __init__(self):
        self.widget = self.initWidget()
        pass

    def initPrinter(self, printer=None, resolution=QPrinter.HighResolution, margins=None):
        default_printer = QPrinter(resolution)
        if not printer:
            if self.printer:
                printer = self.printer
            else:
                self.printer = default_printer
                printer = default_printer

        if not resolution:
            if self.resolution:
                resolution = self.resolution
            else:
                resolution = QPrinter(QPrinter.HighResolution).resolution()
                self.resolution = resolution
        if isinstance(resolution,QPrinter.PrinterMode):
            resolution = QPrinter(resolution).resolution()
        printer.setResolution(resolution)

        PaperToScreen = int( resolution / QPrinter(QPrinter.ScreenResolution).resolution() )
        if self.constPaperScreen is None:
            self.constPaperScreen = PaperToScreen
        
        if margins is None:
            if self.pageMargin:
                margins = self.pageMargin
            else:
                margins = 10
                self.pageMargin = margins
        
        printer.setPageMargins(margins, margins, margins, margins, QPrinter.Millimeter)
        return printer, resolution, PaperToScreen

    def initDocument(self, printer=None, document=None):
        if not printer:
            printer = self.printer
        if not document:
            document = QTextDocument()
        if not self.document:
            self.document = document
        document.setPageSize(QSize(printer.pageRect().size()))
        return document

    def initWidget(self, widget=None):
        if not widget:
            widget = QPrintPreviewDialog()
        if not self.widget:
            self.widget = widget
        widget.paintRequested.connect(self.paintRequest)
        return widget 

    def openWidget(self):
        self.widget.exec_()

    def initStyles(self, constant=None, styles=None):
        if constant is None:
            if self.constPaperScreen:
                constant = self.constPaperScreen
            else:
                constant = 1
                self.constPaperScreen = constant
        if not styles:
            styles = {}
            self.styles = styles

        if not 'header.table' in styles:
            styles.setdefault('header.table',QTextTableFormat())
        styles['header.table'].setBorderStyle(QTextTableFormat.BorderStyle_Solid)
        styles['header.table'].setBorder(1.0)
        styles['header.table'].setBorderBrush(QBrush(Qt.black,Qt.SolidPattern))
        styles['header.table'].setMargin(0.0)
        styles['header.table'].setCellSpacing(0.0)
        styles['header.table'].setCellPadding(10 * constant)
        styles['header.table'].setColumnWidthConstraints([ QTextLength(QTextLength.PercentageLength, 95/self.header_table_cols) ] * self.header_table_cols)

        styles['centerH'] = QTextBlockFormat()
        styles['centerH'].setAlignment(Qt.AlignCenter)
        # TODO: merge styles + use table cell format
        styles['centerV'] = QTextCharFormat()
        styles['centerV'].setVerticalAlignment(QTextCharFormat.VerticalAlignment.AlignMiddle)

        styles['text'] = QTextCharFormat()
        styles['text'].setFont(QFont("Times",10 * constant))
        return styles

    @Slot(QPrinter)
    def paintRequest(self, printer):
        self.printer, self.resolution, self.constPaperScreen = self.initPrinter()
        self.document = self.initDocument()
        self.styles = self.initStyles()
        qDebug('{} {} {}'.format(self.document.pageSize(),self.printer.paperRect(),self.printer.pageLayout().orientation()))
        document = self.makeHeaderTable(self.document,self.styles['header.table'] )
        document.print_(printer)
        

    def makeHeaderTable(self, document, style, rows = header_table_rows, cols = header_table_cols, images = {'left':'college.png','center':'department.jpg'}):
        cursor = QTextCursor(document)
        table = cursor.insertTable(rows,cols,self.styles['header.table'])
        first_element_row = 1
        first_element_col = 0
        num_rows = 1
        num_cols = cols
        table.mergeCells(first_element_row,first_element_col,num_rows,num_cols)
        max_image_width = (document.pageSize() / cols).width()
        image = QImage(images['left'])
        new_image_height = image.height() * max_image_width / image.width()
        image = image.scaled(max_image_width,new_image_height,Qt.KeepAspectRatio,Qt.SmoothTransformation)
        table.cellAt(0,0).firstCursorPosition().insertImage(image)
        image = QImage(images['center'])
        new_image_height = image.height() * max_image_width / image.width()
        image.scaled(max_image_width,new_image_height,Qt.KeepAspectRatio,Qt.SmoothTransformation)
        table.cellAt(0,1).setFormat(self.styles['centerV'])
        table.cellAt(0,1).firstCursorPosition().insertImage(image)
        from random import randint
        a = randint(3,20)
        b = randint(3,20)
        cursor = table.cellAt(0,2).firstCursorPosition()
        cursor.setBlockFormat(self.styles['centerH'])
        table.cellAt(0,2).setFormat(self.styles['centerV'])
        cursor.insertText("Lorem ipsum " * a, self.styles['text'])
        cursor.movePosition(QTextCursor.NextCell)
        cursor.setBlockFormat(self.styles['centerH'])
        table.cellAt(1,0).setFormat(self.styles['centerV'])
        cursor.insertText("Lorem ipsum " * b, self.styles['text'])
        return document

#from PySide2.QtWebEngineWidgets import QWebEngineView
#from PySide2.QtCore import QUrl, QMarginsF
#from PySide2.QtGui import QPageLayout

class AppMainWindow(QApplication):
    def __init__(self):
        super().__init__([])
        self.menu = {}
        self.window = self.loadUi()
        self.window.show()
        self.addMenuItem(["one","two"],["some","other",["menuitem"]])
        self.bind_toolbar_actions()
        self.tableQuestions = tableHelper(self,self.window.tableWidgetQuestions)
        self.window.previewButton.clicked.connect(self.clickedPreview)
        self.sheet = helperPDF()
        self.clickedPreview(True)

    @Slot(bool)
    def clickedPreview(self,checked):
        qDebug("Preview clicked!")
        self.sheet.openWidget()

    """ def testZone(self):
        from PySide2.QtGui import QTextCharFormat, QFont
        from PySide2.QtCore import QSizeF
        qDebug("Initiating test")
        
        self.document = QTextDocument()
        self.printer = QPrinter(QPrinter.HighResolution)
        self.printer.setPageMargins(10,10,10,10,QPrinter.Millimeter)
        self.document.setPageSize(QSizeF(self.printer.pageRect().size()))
        
        c = int(self.printer.resolution()) / int(QPrinter(QPrinter.ScreenResolution).resolution())
        qDebug("c={} pagesize(document)={} resolution(printer)={} pagerect(printer)={} paperrect(printer)={}".format(c,self.document.pageSize(),self.printer.resolution(),self.printer.pageRect(),self.printer.paperRect()))
        #self.printer.setResolution(QPrinter.HighResolution)
        #self.document.setPageSize(QPageSize(QPageSize.A4).size(QPageSize.Point))
        
        
        
        
        self.cursor = QTextCursor(self.document)

        self.preview_widget = QPrintPreviewWidget(self.printer)
        self.preview_widget.setWindowFlags(Qt.Window)
        self.preview_widget.setSinglePageViewMode()
        self.preview_widget.fitInView()
        self.preview_widget.paintRequested.connect(self.document.print_)
        self.preview_widget.resize(600,800)
        
        formato=QTextCharFormat()
        formato.setFont(QFont("Times",10 * c))
        self.cursor.insertText("{}".format(list(range(1,10000))),formato)
        ''' self.preview_widget.show() '''
        #self.document.print_()
        self.diag = PySide2.QtPrintSupport.QPrintPreviewDialog()
        self.diag.paintRequested.connect(self.paintRequest)
        self.diag.exec_()

    @Slot(QPrinter)
    def paintRequest(self,printer):
        qDebug("printer resolution {}".format(printer.resolution()))
        printer.setPageMargins(10.0,10.0,10.0,10.0,PySide2.QtPrintSupport.QPrinter.Millimeter)
        printer.setResolution(QPrinter(QPrinter.HighResolution).resolution())
        document = PySide2.QtGui.QTextDocument()
        document.setPageSize(PySide2.QtCore.QSizeF(printer.pageRect().size()))
        c = int(printer.resolution()) / int(QPrinter(QPrinter.ScreenResolution).resolution())
        cursor = PySide2.QtGui.QTextCursor(document)
        row = 2
        col = 3
        
        style = PySide2.QtGui.QTextTableFormat()
        style.setBorderStyle(PySide2.QtGui.QTextTableFormat.BorderStyle_Solid)
        style.setBorder(1.0)
        style.setBorderBrush(PySide2.QtGui.QBrush(Qt.black,Qt.SolidPattern))
        style.setMargin(0.0)
        style.setCellSpacing(0)
        style.setCellPadding(10*c)
        style.setColumnWidthConstraints([PySide2.QtGui.QTextLength(PySide2.QtGui.QTextLength.PercentageLength,95/col)]*col)
        table = cursor.insertTable(row,col,style)
        table.mergeCells(1,0,1,col)
        newwidth=(document.pageSize()/col).width()
        qDebug("newwidth = {}".format(str(newwidth)))
        table.cellAt(0,0).firstCursorPosition().insertImage(PySide2.QtGui.QImage("college.png").scaledToWidth(newwidth,Qt.SmoothTransformation))
        #uid = PySide2.QtCore.QUuid().createUuid()
        #fmt = PySide2.QtGui.QTextImageFormat()
        #fmt.setName(uid.toString())
        #image = PySide2.QtGui.QImage("department.jpg")
        #document.addResource(PySide2.QtGui.QTextDocument.ImageResource,PySide2.QtCore.QUrl(uid.toString()),image)
        #cursor2 = table.cellAt(0,1).firstCursorPosition()
        #blockformat = PySide2.QtGui.QTextBlockFormat()
        #blockformat.setAlignment(Qt.AlignVCenter)
        #blockformat.setLineHeight(document.idealWidth(),PySide2.QtGui.QTextBlockFormat.FixedHeight)
        #blockformat.setBackground(PySide2.QtGui.QBrush(Qt.black))
        charformat = PySide2.QtGui.QTextImageFormat()
        #charformat.setBackground(Qt.blue)
        charformat.setVerticalAlignment(PySide2.QtGui.QTextCharFormat.VerticalAlignment.AlignMiddle)
        #cursor2 = PySide2.QtGui.QTextTableCellFormat
        table.cellAt(0,1).setFormat(charformat)
        table.cellAt(0,1).firstCursorPosition().insertImage(PySide2.QtGui.QImage("department.jpg").scaledToWidth(newwidth,Qt.SmoothTransformation))
        #blockformat.hei
        #cursor2.insertBlock(blockformat,charformat)
        #fmt.setWidth(document.idealWidth())
        #fmt.setVerticalAlignment(PySide2.QtGui.QTextCharFormat.VerticalAlignment.AlignMiddle)
        #fmt.setBackground(PySide2.QtGui.QBrush(Qt.black))
        #cursor2.insertBlock()
        #cursor2.insertImage(fmt)
        #vcenter = PySide2.QtGui.QTextBlockFormat()
        #vcenter.setAlignment(Qt.AlignVCenter)
        #table.cellAt(0,1).firstCursorPosition().setBlockFormat(vcenter)
        #table.cellAt(0,1).firstCursorPosition().insertImage(PySide2.QtGui.QImage("department.jpg").scaledToWidth(newwidth,Qt.SmoothTransformation))
        textformat = PySide2.QtGui.QTextCharFormat()
        
        textformat.setFont(PySide2.QtGui.QFont("Times",10 * c))
        for x in range(col):
            for y in range(row):
                if y == 0 and x < 2:
                    continue
                if y == 1 and x > 0:
                    continue
                cursor = table.cellAt(y,x).firstCursorPosition()
                bf = cursor.blockFormat()
                #align_vertical = bf.alignment() & Qt.AlignVertical_Mask
                #align_vertical = Qt.AlignVCenter & Qt.AlignVertical_Mask
                #align_horizontal = Qt.AlignHCenter & Qt.AlignHorizontal_Mask
                #align = align_vertical | align_horizontal
                #bf.setAlignment(align)
                bf.setAlignment(Qt.AlignCenter)
                cursor.setBlockFormat(bf)
                f = PySide2.QtGui.QTextCharFormat()
                #f.setBackground(Qt.blue)
                f.setVerticalAlignment(PySide2.QtGui.QTextCharFormat.VerticalAlignment.AlignMiddle)
                # funcional 
                table.cellAt(y,x).setFormat(f)
                # funcional tambien cursor.setBlockCharFormat(f)
                import random
                cursor.insertText("({},{}) {}".format(x,y,"Loren ipsum "*random.randint(1,20)),textformat)
                #cursor.movePosition(PySide2.QtGui.QTextCursor.NextCell)
        document.print_(printer)
        pass
 """    
    # @Slot(bool)
    # def finished(self):
    #     qDebug('Finished')
    #     self.view.show()
    #     self.page = self.view.page()
    #     self.page.printToPdf("webpage.pdf",QPageLayout(QPageSize(QPageSize.A4),QPageLayout.Portrait,QMarginsF()))

    def loadUi(self):
        ui_file = QFile("mainwindow.ui")
        ui_file.open(QFile.ReadOnly)
        ui_loader = QUiLoader(self)
        window = ui_loader.load(ui_file)
        ui_file.close()
        return window

    def bind_toolbar_actions(self):
        for action in dir(self.window):
            action_obj = getattr(self.window,action)
            if isinstance(action_obj,QAction):
                action_obj.setData(action_obj.text())
                action_obj.triggered.connect(self.test)

    @Slot()
    def test(self):
        data = self.sender().data()
        qDebug("senderData:{}".format(data))
        self.window.statusbar.showMessage("Action from '{}' triggered".format(data),10*1000)
        self.tableQuestions.addItem(data)
        pass

    def calculate_default_menubar_shortcut(self,name):
        used = []
        for item in self.menu:
            for character in item:
                if character in used:
                    continue
                else:
                    used.append(character)
                    break
        newname = ""
        done = False
        for character in name:
            if done or character in used:
                newname += character
            else:
                newname += "&" + character
                done = True

        return newname

    def addMenuItem(self, *args, **kwargs):
        for name in args:
            if isinstance(name,list):
                self.addMenuItem(*name)
                continue
            if not isinstance(name,str) or name in self.menu:
                continue
            name_with_shortcut = self.calculate_default_menubar_shortcut(name)
            self.menu.setdefault(name,[])
            self.menu[name].append(self.window.menubar.addMenu(name_with_shortcut))
            action = Helper().genAction(name=name,fn=self.test,icon=TESTICON,tip=name,parent=self.menu[name][0],data=name)
            self.menu[name][0].addAction(action)

if __name__ == "__main__":
    QApplication.setAttribute(Qt.AA_ShareOpenGLContexts)
    app = AppMainWindow()
    sys.exit(app.exec_())
